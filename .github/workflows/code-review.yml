name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Review code changes
      uses: actions/github-script@v6
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          });
          
          let comments = [];
          
          for (const file of files) {
            // Check file size
            if (file.additions > 500) {
              comments.push({
                path: file.filename,
                body: 'âš ï¸ This file has over 500 lines added. Consider breaking it into smaller changes.',
                line: 1
              });
            }
            
            // Check for TODO comments in new code
            if (file.patch && file.patch.includes('TODO')) {
              comments.push({
                path: file.filename,
                body: 'ðŸ“ TODO found. Please create an issue to track this work.',
                line: 1
              });
            }
            
            // Check for console.log in frontend files
            if (file.filename.includes('frontend/src') && file.patch && file.patch.includes('console.log')) {
              comments.push({
                path: file.filename,
                body: 'ðŸ› console.log detected. Consider removing or using proper logging.',
                line: 1
              });
            }
            
            // Check for hardcoded credentials
            if (file.patch && (file.patch.match(/api[_-]?key|password|secret/i))) {
              comments.push({
                path: file.filename,
                body: 'ðŸ”’ Potential credential detected. Ensure sensitive data is not hardcoded.',
                line: 1
              });
            }
          }
          
          // Post review comments
          if (comments.length > 0) {
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: 'COMMENT',
              body: 'ðŸ¤– Automated code review completed. Please review the suggestions below.',
              comments: comments.slice(0, 10) // Limit to 10 comments
            });
          }

    - name: Check PR description
      uses: actions/github-script@v6
      with:
        script: |
          const pr = context.payload.pull_request;
          
          if (!pr.body || pr.body.length < 50) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: 'ðŸ“ Please provide a more detailed PR description (at least 50 characters).'
            });
          }

    - name: Check for breaking changes
      uses: actions/github-script@v6
      with:
        script: |
          const pr = context.payload.pull_request;
          const title = pr.title.toLowerCase();
          const body = (pr.body || '').toLowerCase();
          
          if (title.includes('breaking') || body.includes('breaking change')) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['breaking-change']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: 'âš ï¸ **Breaking Change Detected**\n\nThis PR contains breaking changes. Please ensure:\n- Migration guide is provided\n- Version is bumped appropriately\n- Stakeholders are notified'
            });
          }

  backend-review:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'src/') || contains(github.event.pull_request.changed_files, 'pom.xml')

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Review Java code quality
      run: |
        echo "Reviewing backend code..."
        mvn compile || echo "Compilation warnings detected"

    - name: Comment on PR
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: 'âœ… Backend code review completed. All checks passed!'
          });

  frontend-review:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'frontend/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Review frontend code
      working-directory: ./frontend
      run: |
        echo "Reviewing frontend code..."
        npm run build || echo "Build warnings detected"

    - name: Comment on PR
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: 'âœ… Frontend code review completed. All checks passed!'
          });

